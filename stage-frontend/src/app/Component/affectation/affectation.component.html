<div class="affectation-container">
  <div class="header-section">
    <h2>üß© Affecter Module √† des Classes</h2>
    <p class="subtitle">Assignez des modules aux classes pour organiser l'enseignement</p>
  </div>

  <form (ngSubmit)="affecter()" class="form-section" novalidate>
    <!-- Step 1: Module Selection -->
    <div class="form-step">
      <div class="step-header">
        <span class="step-number">1</span>
        <h3>üìö S√©lectionner le Module</h3>
      </div>
      <div class="form-group">
        <label for="moduleSelect">
          <i class="pi pi-book"></i>
          Module √† assigner
        </label>
        <select id="moduleSelect" [(ngModel)]="selectedModuleId" name="module" required class="form-control">
          <option value="" disabled selected>-- Choisir un module --</option>
          <option *ngFor="let module of modules" [value]="module.id">
            {{ module.libelleModule }}
          </option>
        </select>
        <div class="form-help" *ngIf="selectedModuleId">
          <i class="pi pi-check-circle"></i>
          Module s√©lectionn√©: {{ getSelectedModuleName() }}
        </div>
      </div>
    </div>

    <!-- Step 2: Period Selection -->
    <div class="form-step">
      <div class="step-header">
        <span class="step-number">2</span>
        <h3>üìÖ S√©lectionner la P√©riode</h3>
      </div>
      <div class="form-group">
        <label for="periodeSelect">
          <i class="pi pi-calendar"></i>
          P√©riode acad√©mique
        </label>
        <select id="periodeSelect" [(ngModel)]="selectedPeriode" name="periode" required class="form-control">
          <option *ngFor="let p of periodes" [value]="p">{{ getPeriodeDisplayName(p) }}</option>
        </select>
        <div class="form-help">
          <i class="pi pi-info-circle"></i>
          Choisissez la p√©riode pendant laquelle ce module sera enseign√©
        </div>
      </div>
    </div>

    <!-- Step 3: Class Filtering -->
    <div class="form-step">
      <div class="step-header">
        <span class="step-number">3</span>
        <h3>üéØ Filtrer les Classes</h3>
      </div>
      <div class="form-group">
        <label for="optionSelect">
          <i class="pi pi-filter"></i>
          Option de classe
        </label>
        <select
          id="optionSelect"
          [(ngModel)]="selectedOptionGroupe"
          (change)="onOptionGroupeChange($event)"
          name="optionGroupe"
          required
          class="form-control"
        >
          <option value="" disabled>-- Toutes les options --</option>
          <option *ngFor="let option of optionsGroupe" [value]="option">{{ option }}</option>
        </select>
        <div class="form-help" *ngIf="selectedOptionGroupe">
          <i class="pi pi-check-circle"></i>
          {{ filteredGroupes.length }} classe(s) trouv√©e(s) pour l'option {{ selectedOptionGroupe }}
        </div>
      </div>
    </div>

    <!-- Step 4: Class Selection -->
    <div class="form-step">
      <div class="step-header">
        <span class="step-number">4</span>
        <h3>üë• S√©lectionner les Classes</h3>
      </div>
      <div class="form-group full-width">
        <label for="groupesSelect">
          <i class="pi pi-users"></i>
          Classes √† assigner (s√©lection multiple)
        </label>
        <div class="classes-selection-container">
          <select
            id="groupesSelect"
            multiple
            [(ngModel)]="selectedGroupeIds"
            name="groupes"
            required
            size="6"
            class="form-control classes-select"
          >
            <option *ngFor="let g of filteredGroupes" [value]="g.id">
              {{ getDisplayClassName(g) }} ‚Äî Niveau: {{ g.niveau }} ‚Äî Effectif: {{ g.effectif }} ‚Äî D√©partement: {{ g.departement }}
            </option>
          </select>
          <div class="selection-info">
            <div class="selection-count">
              <i class="pi pi-check-circle"></i>
              {{ selectedGroupeIds.length }} classe(s) s√©lectionn√©e(s)
            </div>
            <div class="selection-actions">
              <button type="button" class="btn-select-all" (click)="selectAllClasses()">
                <i class="pi pi-check-square"></i> Tout s√©lectionner
              </button>
              <button type="button" class="btn-clear-selection" (click)="clearSelection()">
                <i class="pi pi-times"></i> Effacer
              </button>
            </div>
          </div>
        </div>
        <div class="form-help">
          <i class="pi pi-info-circle"></i>
          Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs classes
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button type="submit" class="btn-affecter" [disabled]="!isFormValid()" aria-label="Affecter le module aux classes">
        <i class="pi pi-check"></i>
        <span>‚úÖ Affecter le Module</span>
        <span class="btn-loading-text" *ngIf="isLoading">En cours...</span>
      </button>
    </div>
  </form>

  <hr />

  <h3>üìã Liste des Affectations</h3>
  <table class="table" aria-label="Liste des affectations">
    <thead>
      <tr>
        <th>Module</th>
        <th>Classe</th>
        <th>P√©riode</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let aff of affectations">
        <td>{{ aff.module.libelleModule }}</td>
        <td>
  {{ getDisplayClassName(aff.groupe) }}
  <br />
  <small *ngIf="aff.groupe.niveau">
    Niveau: {{ aff.groupe.niveau }} |
    Option: {{ aff.groupe.optionGroupe }} |
    Effectif: {{ aff.groupe.effectif }} |
    D√©partement: {{ aff.groupe.departement }}
  </small>
</td>

        <td>{{ aff.periode }}</td>
        <td>
          <button (click)="deleteAffectation(aff.id)" aria-label="Supprimer l'affectation">
            ‚ùå Supprimer
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
